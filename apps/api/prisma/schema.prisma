generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER & AUTH
// ==========================================

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  avatarUrl    String?  @map("avatar_url")

  // MFA fields
  mfaEnabled      Boolean  @default(false) @map("mfa_enabled")
  mfaSecret       String?  @map("mfa_secret") @db.Text
  mfaBackupCodes  String?  @map("mfa_backup_codes") @db.Text
  mfaPendingSetup Boolean  @default(false) @map("mfa_pending_setup")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  memberships  Membership[]
  auditLogs    AuditLog[]   @relation("AuditActor")
  refreshTokens RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique @db.VarChar(500)
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ==========================================
// TENANT & MEMBERSHIP
// ==========================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  memberships  Membership[]
  projects     Project[]
  auditLogs    AuditLog[]
  subscription Subscription?

  @@map("tenants")
}

enum MemberRole {
  OWNER
  ADMIN
  ANALYST
}

model Membership {
  id        String     @id @default(cuid())
  userId    String     @map("user_id")
  tenantId  String     @map("tenant_id")
  role      MemberRole @default(ANALYST)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@map("memberships")
}

// ==========================================
// PROJECT & CONFIGURATION
// ==========================================

enum ProjectStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

model Project {
  id            String        @id @default(cuid())
  tenantId      String        @map("tenant_id")
  name          String
  domain        String
  status        ProjectStatus @default(ACTIVE)
  timezone      String        @default("America/Sao_Paulo")
  retentionDays Int           @default(90) @map("retention_days")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  tenant                  Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  apiKeys                 ApiKey[]
  integrationMeta         IntegrationMeta?
  consentLogs             ConsentLog[]
  errorLogs               ErrorLog[]
  exportJobs              ExportJob[]
  leadIntegrations        LeadIntegration[]
  leadFormConfigs         LeadFormConfig[]
  leadNotificationConfigs LeadNotificationConfig[]

  @@unique([tenantId, domain])
  @@index([tenantId])
  @@map("projects")
}

// ==========================================
// API KEYS
// ==========================================

model ApiKey {
  id           String    @id @default(cuid())
  projectId    String    @map("project_id")
  name         String
  keyHash      String    @unique @map("key_hash")
  keyPrefix    String    @map("key_prefix") @db.VarChar(12)
  keyEncrypted String?   @map("key_encrypted") @db.Text
  secretHash   String    @map("secret_hash")
  scopes       Json      @default("[]")
  createdAt    DateTime  @default(now()) @map("created_at")
  lastUsedAt   DateTime? @map("last_used_at")
  revokedAt    DateTime? @map("revoked_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([keyPrefix])
  @@map("api_keys")
}

// ==========================================
// INTEGRATIONS
// ==========================================

model IntegrationMeta {
  id                   String   @id @default(cuid())
  projectId            String   @unique @map("project_id")
  pixelId              String   @map("pixel_id")
  accessTokenEncrypted String   @map("access_token_encrypted") @db.Text
  testEventCode        String?  @map("test_event_code")
  enabled              Boolean  @default(true)
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("integrations_meta")
}

// ==========================================
// CONSENT & PRIVACY
// ==========================================

model ConsentLog {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  anonymousId String   @map("anonymous_id")
  categories  Json
  source      String   @default("sdk") // sdk, api, manual
  ipHash      String?  @map("ip_hash")
  userAgent   String?  @map("user_agent") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([anonymousId])
  @@index([createdAt])
  @@map("consent_logs")
}

// ==========================================
// AUDIT & ERROR LOGS
// ==========================================

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  actorUserId String?  @map("actor_user_id")
  action      String
  resource    String
  resourceId  String?  @map("resource_id")
  payload     Json?
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor  User?  @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([actorUserId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model ErrorLog {
  id        String   @id @default(cuid())
  projectId String   @map("project_id")
  type      String   // validation, integration, processing
  message   String   @db.Text
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type])
  @@index([createdAt])
  @@map("error_logs")
}

// ==========================================
// LEAD CAPTURE INTEGRATIONS
// ==========================================

enum LeadPlatform {
  FACEBOOK
  INSTAGRAM
  TWITTER
  WEBSITE
}

enum LeadIntegrationStatus {
  ACTIVE
  INACTIVE
  PENDING
  ERROR
}

model LeadIntegration {
  id                    String                @id @default(cuid())
  projectId             String                @map("project_id")
  platform              LeadPlatform
  status                LeadIntegrationStatus @default(PENDING)
  accessTokenEncrypted  String?               @map("access_token_encrypted") @db.Text
  refreshTokenEncrypted String?               @map("refresh_token_encrypted") @db.Text
  tokenExpiresAt        DateTime?             @map("token_expires_at")
  pageId                String?               @map("page_id")
  pageName              String?               @map("page_name")
  formIds               Json?                 @map("form_ids")
  webhookSecret         String?               @map("webhook_secret")
  lastSyncAt            DateTime?             @map("last_sync_at")
  errorMessage          String?               @map("error_message") @db.Text
  metadata              Json?
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, platform])
  @@index([projectId])
  @@index([platform])
  @@map("lead_integrations")
}

model LeadFormConfig {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  name        String
  fields      Json
  styling     Json?
  submitUrl   String?  @map("submit_url")
  redirectUrl String?  @map("redirect_url")
  enabled     Boolean  @default(true)
  embedCode   String   @map("embed_code") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("lead_form_configs")
}

model LeadNotificationConfig {
  id         String   @id @default(cuid())
  projectId  String   @map("project_id")
  email      String?
  webhookUrl String?  @map("webhook_url")
  platforms  Json
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("lead_notification_configs")
}

// ==========================================
// EXPORTS
// ==========================================

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ExportType {
  EVENTS_RAW
  EVENTS_AGG
  FUNNEL
  REVENUE
}

model ExportJob {
  id         String       @id @default(cuid())
  projectId  String       @map("project_id")
  type       ExportType
  status     ExportStatus @default(PENDING)
  params     Json
  fileUrl    String?      @map("file_url")
  error      String?      @db.Text
  createdAt  DateTime     @default(now()) @map("created_at")
  finishedAt DateTime?    @map("finished_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@index([createdAt])
  @@map("export_jobs")
}

// ==========================================
// BILLING & SUBSCRIPTIONS
// ==========================================

enum PlanTier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
  DISPUTED
}

model Plan {
  id                String   @id @default(cuid())
  name              String
  tier              PlanTier @unique
  description       String?  @db.Text
  monthlyPrice      Int      @map("monthly_price") // in cents
  yearlyPrice       Int      @map("yearly_price") // in cents
  stripePriceIdMonthly String? @map("stripe_price_id_monthly")
  stripePriceIdYearly  String? @map("stripe_price_id_yearly")

  // Limits
  maxProjects       Int      @default(1) @map("max_projects")
  maxEventsPerMonth Int      @default(10000) @map("max_events_per_month")
  maxTeamMembers    Int      @default(1) @map("max_team_members")
  retentionDays     Int      @default(30) @map("retention_days")

  // Features (JSON array of feature keys)
  features          Json     @default("[]")

  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  subscriptions     Subscription[]

  @@map("plans")
}

model Subscription {
  id                    String             @id @default(cuid())
  tenantId              String             @unique @map("tenant_id")
  planId                String             @map("plan_id")
  status                SubscriptionStatus @default(TRIALING)

  // Stripe IDs
  stripeCustomerId      String?            @map("stripe_customer_id")
  stripeSubscriptionId  String?            @unique @map("stripe_subscription_id")

  // Billing cycle
  billingInterval       String             @default("monthly") @map("billing_interval") // monthly or yearly
  currentPeriodStart    DateTime?          @map("current_period_start")
  currentPeriodEnd      DateTime?          @map("current_period_end")

  // Trial
  trialStart            DateTime?          @map("trial_start")
  trialEnd              DateTime?          @map("trial_end")

  // Cancellation
  cancelAtPeriodEnd     Boolean            @default(false) @map("cancel_at_period_end")
  canceledAt            DateTime?          @map("canceled_at")

  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")

  tenant                Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan                  Plan               @relation(fields: [planId], references: [id])
  invoices              Invoice[]
  usageRecords          UsageRecord[]

  @@index([planId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

model Invoice {
  id                   String        @id @default(cuid())
  subscriptionId       String        @map("subscription_id")
  stripeInvoiceId      String?       @unique @map("stripe_invoice_id")

  amountDue            Int           @map("amount_due") // in cents
  amountPaid           Int           @default(0) @map("amount_paid")
  currency             String        @default("usd")
  status               PaymentStatus @default(PENDING)

  invoiceUrl           String?       @map("invoice_url") @db.Text
  invoicePdf           String?       @map("invoice_pdf") @db.Text

  periodStart          DateTime      @map("period_start")
  periodEnd            DateTime      @map("period_end")
  dueDate              DateTime?     @map("due_date")
  paidAt               DateTime?     @map("paid_at")

  createdAt            DateTime      @default(now()) @map("created_at")

  subscription         Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@map("invoices")
}

model UsageRecord {
  id               String       @id @default(cuid())
  subscriptionId   String       @map("subscription_id")

  periodStart      DateTime     @map("period_start")
  periodEnd        DateTime     @map("period_end")

  eventsCount      Int          @default(0) @map("events_count")
  projectsCount    Int          @default(0) @map("projects_count")
  teamMembersCount Int          @default(0) @map("team_members_count")

  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  subscription     Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, periodStart])
  @@index([subscriptionId])
  @@map("usage_records")
}
